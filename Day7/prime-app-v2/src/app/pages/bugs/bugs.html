<div class="bugs-container">
  <p-card header="Bug Dashboard" [styleClass]="'bugs-card'">
    <!-- Authentication Check -->
    <div *ngIf="!isAuthenticated" class="auth-required">
      <div class="auth-message">
        <i class="pi pi-lock" style="font-size: 3rem; color: #667eea;"></i>
        <h3>Authentication Required</h3>
        <p>You must be logged in to view bugs.</p>
        <p-button 
          label="Go to Login" 
          icon="pi pi-sign-in" 
          (onClick)="goToLogin()"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </div>

    <!-- Authenticated Content -->
    <div *ngIf="isAuthenticated">
      <div class="bugs-header">
        <h2>Bugs</h2>

        <div class="filter-group">
          <p-dropdown
            [options]="statuses"
            [(ngModel)]="selectedStatus"
            optionLabel="label"
            optionValue="value"
            placeholder="Filter by Status"
            (onChange)="filterBugs()"
            [style]="{'width':'180px'}">
          </p-dropdown>

          <p-dropdown
            [options]="priorities"
            [(ngModel)]="selectedPriority"
            optionLabel="label"
            optionValue="value"
            placeholder="Filter by Priority"
            (onChange)="filterBugs()"
            [style]="{'width':'180px'}">
          </p-dropdown>

          <p-button
            label="Refresh"
            icon="pi pi-refresh"
            (onClick)="loadBugs()"
            [loading]="loading"
            styleClass="p-button-outlined">
          </p-button>
        </div>
      </div>

      <div *ngIf="loading" class="loading-container">
        <p-progressSpinner></p-progressSpinner>
        <p>Loading bugs...</p>
      </div>

      <div *ngIf="!loading && bugs.length > 0">
        <p-table 
          [value]="filteredBugs" 
          [paginator]="true" 
          [rows]="5"
          [rowsPerPageOptions]="[5, 10, 20]"
          [tableStyle]="{'min-width': '60rem'}"
          styleClass="p-datatable-sm"
          [responsiveLayout]="'scroll'">

          <ng-template pTemplate="header">
            <tr>
              <th (click)="sortBugs('id')">
                ID 
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['id'],
                    'pi-sort-amount-up-alt': sortDirection['id'] === 'asc',
                    'pi-sort-amount-down': sortDirection['id'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('title')">
                Title 
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['title'],
                    'pi-sort-amount-up-alt': sortDirection['title'] === 'asc',
                    'pi-sort-amount-down': sortDirection['title'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('description')">
                Description
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['description'],
                    'pi-sort-amount-up-alt': sortDirection['description'] === 'asc',
                    'pi-sort-amount-down': sortDirection['description'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('status')">
                Status
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['status'],
                    'pi-sort-amount-up-alt': sortDirection['status'] === 'asc',
                    'pi-sort-amount-down': sortDirection['status'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('priority')">
                Priority
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['priority'],
                    'pi-sort-amount-up-alt': sortDirection['priority'] === 'asc',
                    'pi-sort-amount-down': sortDirection['priority'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('createdAt')">
                Created Date
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['createdAt'],
                    'pi-sort-amount-up-alt': sortDirection['createdAt'] === 'asc',
                    'pi-sort-amount-down': sortDirection['createdAt'] === 'desc'
                  }"></i>
              </th>
              <th (click)="sortBugs('projectId')">
                Project ID
                <i class="pi" 
                  [ngClass]="{
                    'pi-sort': !sortDirection['projectId'],
                    'pi-sort-amount-up-alt': sortDirection['projectId'] === 'asc',
                    'pi-sort-amount-down': sortDirection['projectId'] === 'desc'
                  }"></i>
              </th>
            </tr>
          </ng-template>


          <ng-template pTemplate="body" let-bug>
            <tr>
              <td>{{bug.id}}</td>
              <td>{{bug.title}}</td>
              <td>{{bug.description}}</td>
              <td>
                <span class="status-badge" [class]="'status-' + bug.status.toLowerCase()">
                  {{bug.status}}
                </span>
              </td>
              <td>
                <span [ngClass]="'priority-' + bug.priority.toLowerCase()">
                  {{bug.priority}}
                </span>
              </td>
              <td>{{bug.createdAt | date:'short'}}</td>
              <td>{{bug.projectId}}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center">No bugs found</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <div *ngIf="!loading && bugs.length === 0 && !error" class="no-bugs">
        <p>No bugs available</p>
      </div>

      <div *ngIf="error" class="error-message">
        <p-message severity="error" [text]="error" styleClass="error-msg"></p-message>
      </div>
    </div>
  </p-card>
</div>
